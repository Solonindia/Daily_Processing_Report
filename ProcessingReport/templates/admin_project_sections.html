{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Planning Working Dashboard</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    body {
      margin: 0;
      background: linear-gradient(120deg, #a1c4fd, #c2e9fb);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .navbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: white;
      padding: 15px 30px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .navbar-left {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .navbar img {
      height: 40px;
    }

    .navbar h2 {
      margin: 0;
      font-size: 22px;
      color: #003366;
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
    }

    .nav-links a {
      text-decoration: none;
      margin-left: 20px;
      color: #003366;
      font-weight: 500;
    }

    .nav-links a:hover {
      color: #0d6efd;
    }

    .main-content {
      padding: 10px;
    }

    .project-selection {
      text-align: center;
      margin-bottom: 30px;
    }

    .project-selection form {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
    }

    .project-selection label {
      font-weight: bold;
      color: #003366;
    }

    .project-selection select {
      padding: 8px 14px;
      width: 250px;
      border: 1px solid #aaa;
      border-radius: 5px;
      font-size: 14px;
    }

    .btn {
      padding: 8px 14px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
    }

    .btn-add {
      background-color: #0d6efd;
      color: white;
    }

    .btn-save {
      background-color: #198754;
      color: white;
    }

    .btn-remove {
      background-color: #dc3545;
      color: white;
    }

    .card {
      background-color: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 30px;
      box-shadow: 0 3px 6px rgba(0,0,0,0.1);
    }

    .table-responsive {
      overflow-x: auto;
      max-width: 100%;
      margin-top: 20px; /* gap between section input and table */
    }

    table {
      width: 100%;
      min-width: 1100px;
      border-collapse: collapse;
      font-size: 13px;
      
    }

    /* th,  */
    td {
      border: 1px solid #dee2e6;
      padding: 6px;
      text-align: center;
      vertical-align: middle;
    }

    th {
      border: 1px solid #dee2e6;
      padding: 10px;
      text-align: center;
      vertical-align: middle;
    }

    .form-label {
      margin-bottom: 5px;
      display: block;
    }

    .d-flex {
      display: flex;
    }

    .gap-2 {
      gap: 10px;
    }

    .justify-content-between {
      justify-content: space-between;
    }

    .align-items-center {
      align-items: center;
    }

    .mb-4 {
      margin-bottom: 1.5rem;
    }

    .mb-3 {
      margin-bottom: 1rem;
    }

    .row-number {
      width: 50px;
    }

    input[type="text"] {
      width: 100%;
      padding: 5px;
      box-sizing: border-box;
    }
    .logout-form button:hover {
  color: #0d6efd;
}
/* .scaled-container {
  transform: scale(0.8);        
  transform-origin: top center;  
  width: 100%;
} */


  </style>
</head>
<body>

  <div class="navbar">
    <div class="navbar-left">
      <img src="{% static 'Solon-Logo.png' %}" alt="Logo">
    </div>
    <h2>üìÇ Planning Working Dashboard</h2>
    


    <div class="nav-links" style="display: flex; align-items: center; gap: 30px;">
      <a href="{% url 'admin' %}" style="color: #003366; font-weight: 500; text-decoration: none;">
        <i class="fas fa-chart-line"></i> Admin Dashboard
      </a>
      
      {% if user.is_authenticated %}
        <form action="{% url 'logout' %}" method="POST" class="logout-form" style="margin: 0; padding: 0;">
          {% csrf_token %}
          <button type="submit" style="background: none; border: none; padding: 0; color: #003366; font-weight: 500; font-family: inherit; cursor: pointer;font-size: 16px;">
            <i class="fas fa-sign-out-alt"></i> Logout
          </button>
        </form>
      {% endif %}
    </div>

  </div>

  <div class="scaled-container">
  <div class="main-content">

    <div class="project-selection">
      <form method="get">
        <label for="project">Select Project:</label>
        <select name="project_id" id="project" onchange="this.form.submit()">
          <option value="">-- Choose Project --</option>
          {% for access in project_access_list %}
            <option value="{{ access.id }}" {% if access.id|stringformat:"s" == selected_project_id %}selected{% endif %}>
              {{ access.project_name }}
            </option>
          {% endfor %}
        </select>
      </form>
    </div>
  

    {% if selected_project_id %}
    <form method="post" id="sections-form">
      {% csrf_token %}
      <input type="hidden" name="project_id" value="{{ selected_project_id }}">
      <input type="hidden" id="total_sections" name="total_sections" value="0">

      <div id="sections-wrapper"></div>

      <div class="d-flex gap-2">
        <button type="button" class="btn btn-add" onclick="addSection()">‚ûï Add Section</button>
        <button type="submit" class="btn btn-save">üíæ Save All</button>
      </div>
    </form>
    {% endif %}
  </div>
  </div>

  <script id="sections-data" type="application/json">{{ sections_data|safe }}</script>

  <script>
    let sectionIndex = 0;

    function addSection(title = '', items = [], sectionId = '') {
      const wrapper = document.getElementById('sections-wrapper');
      const sectionDiv = document.createElement('div');
      sectionDiv.className = 'card';
      sectionDiv.setAttribute('data-section-index', sectionIndex);

      sectionDiv.innerHTML = `
        <input type="hidden" name="section_id_${sectionIndex}" value="${sectionId}">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <label class="form-label">Section <strong>${sectionIndex + 1}</strong> Title:</label>
          <button type="button" class="btn btn-remove" onclick="removeSection(this)">‚ùå Remove Section</button>
        </div>
        <input type="text" name="section_title_${sectionIndex}" value="${title}" placeholder="Enter section title...">

        <div class="table-responsive">
          <table>
            <thead>
              <tr>
                <th>SL.NO</th>
                <th>Description</th>
                <th>UOM</th>
                <th>Target Start</th>
                <th>Target End</th>
                <th>Actual Start</th>
                <th>Actual End</th>
                <th>Scope</th>
                <th>Expected</th>
                <th>Today</th>
                <th>Completed</th>
                <th>Balance</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="section_items_${sectionIndex}"></tbody>
          </table>
        </div>
      `;

      wrapper.appendChild(sectionDiv);

      if (items.length > 0) {
        items.forEach(item =>
          addRow(sectionIndex, item.description, item.uom, item.id, item.scope, item.targeted_start_date, item.targeted_end_date, null, item.expected_today, item.today_progress, item.completed, item.balance, item.status, item.actual_start_date, item.actual_end_date)
        );
      } else {
        addRow(sectionIndex);
      }

      sectionIndex++;
      document.getElementById("total_sections").value = sectionIndex;
      updateRowNumbers();
    }

    function addRow(sectionIdx, desc = '', uom = '', itemId = '', scope = '', start = '', end = '', insertAfter = null, expected = '-', today = '-', completed = '-', balance = '-', status = '-', actualStart = '-', actualEnd = '-') {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td class="row-number" style="width: 30px;"></td>
        <td><input type="text" name="description_${sectionIdx}[]" value="${desc}" placeholder="Description" style="width: 150px;"></td>
        <td><input type="text" name="uom_${sectionIdx}[]" value="${uom}" placeholder="UOM" style="width: 50px;"><input type="hidden" name="item_id_${sectionIdx}[]" value="${itemId}"></td>
        <td><input type="text" name="targeted_start_date_${sectionIdx}[]" value="${start}" placeholder="dd-mm-yyyy" style="width: 90px;"></td>
        <td><input type="text" name="targeted_end_date_${sectionIdx}[]" value="${end}" placeholder="dd-mm-yyyy" style="width: 90px;"></td>
        <td><input type="text" value="${actualStart}" readonly placeholder="dd-mm-yyyy" style="width: 90px;"></td>
        <td><input type="text" value="${actualEnd}" readonly placeholder="dd-mm-yyyy" style="width: 90px;"></td>
        <td><input type="number" name="scope_${sectionIdx}[]" value="${scope}" placeholder="Scope" style="width: 55px;"></td>
        <td>${expected}</td>
        <td>${today}</td>
        <td>${completed}</td>
        <td>${balance}</td>
        <td>${status}</td>
        <td>
          <button type="button" onclick="addRowFromButton(this)">‚ûï</button>
          <button type="button" onclick="removeRow(this)">üóëÔ∏è</button>
        </td>
      `;

      const tbody = document.getElementById(`section_items_${sectionIdx}`);
      if (insertAfter) {
        insertAfter.parentNode.insertBefore(row, insertAfter.nextSibling);
      } else {
        tbody.appendChild(row);
      }

      updateRowNumbers();
    }

    function addRowFromButton(btn) {
      const row = btn.closest('tr');
      const sectionIdx = row.closest('tbody').id.split("_")[2];
      addRow(sectionIdx, '', '', '', '', '', '', row);
    }

    function removeRow(btn) {
      btn.closest('tr').remove();
      updateRowNumbers();
    }

    function removeSection(btn) {
      btn.closest('.card').remove();
      updateSectionIndices();
    }

    function updateSectionIndices() {
      const cards = document.querySelectorAll('#sections-wrapper .card');
      sectionIndex = 0;
      cards.forEach(card => {
        card.setAttribute('data-section-index', sectionIndex);
        card.querySelector('label strong').innerText = sectionIndex + 1;
        sectionIndex++;
      });
      document.getElementById("total_sections").value = sectionIndex;
      updateRowNumbers();
    }

    function updateRowNumbers() {
      document.querySelectorAll('#sections-wrapper .card').forEach((card, secIdx) => {
        card.querySelectorAll('tbody tr').forEach((row, rowIdx) => {
          row.querySelector('.row-number').innerText = `${secIdx + 1}.${rowIdx + 1}`;
        });
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      const sections = JSON.parse(document.getElementById("sections-data").textContent || "[]");
      sections.forEach(section => {
        addSection(section.title, section.items, section.id);
      });
    });
  </script>

</body>
</html>

